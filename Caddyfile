# Caddy configuration with environment variable support
# Domain is read from DOMAIN environment variable (set in .env file)
# Supports both main domain and www subdomain

# Main domain and www subdomain
{env.DOMAIN}, www.{env.DOMAIN} {
    # Cloudflare DNS challenge for SSL (if CLOUDFLARE_API_TOKEN is set)
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }

    # Redirect www to non-www (optional - uncomment if you want to redirect www to main domain)
    # @www host www.{env.DOMAIN}
    # redir @www https://{env.DOMAIN}{uri} permanent

    # Reverse proxy for API
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy backend:8000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Serve frontend static files
    handle {
        reverse_proxy frontend:80 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}

